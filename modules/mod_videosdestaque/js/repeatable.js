!function(e){e.JRepeatable=function(t,n,a,o){var i,n,r,a=null,s=null,l=null,c=(e(t+"_button"),!1),d=null,h=e("<div>");h.css({"background-color":"#000",opacity:.4,"z-index":9998,position:"fixed",left:0,top:0,height:"100%",width:"100%"}).hide(),h.appendTo("body"),openWindow=function(){s||(makeWin(),l.prependTo(s)),l.show(),s.show(),resizeWin(),h.show(),r=getTrs().clone()},makeWin=function(){if(!s){s=e("<div/>"),s.css({padding:"5px","background-color":"#fff",display:"none","z-index":9999,position:"absolute",left:"50%",top:e(document).scrollTop()+e(window).height()/2-s.outerHeight()/2}),s.appendTo("body");var t=e('<button class="btn button btn-primary"/>').text(Joomla.JText._("JAPPLY"));t.on("click",function(e){e.stopPropagation(),store(),d.find("table").replaceWith(l),close()});var n=e('<button class="btn button btn-link"/>').text(Joomla.JText._("JCANCEL"));n.on("click",function(t){c=!0,t.stopPropagation(),e(l).find("tbody tr").replaceWith(r),d.find("table").replaceWith(l),close(),s=null});var a=e('<div class="controls form-actions"/>').css({"text-align":"right","margin-bottom":0}).append([n,t]);s.append(l),s.append(a),c||build(),watchButtons()}},resizeWin=function(){var e=-1*(s.width()/2);s.css({"margin-left":e})},close=function(){l.hide(),s.hide(),h.hide()},getRadioValues=function(){var t=[];return e.each(getTrs(),function(n,a){var o=e(a).find('input[type="radio"]:checked'),i=o.length>0?o.val():i="";t.push(i)}),t},setRadioValues=function(t){e.each(getTrs(),function(n,a){var o=e(a).find('input[type="radio"][value="'+t[n]+'"]');o.length>0&&o.attr("checked","checked")})},watchButtons=function(){s.on("click","a.add",function(n){if(tr=findTr(n)){var a=document.getElementById(t+"_table").getElementsByTagName("tbody")[0].getElementsByTagName("tr").length;if(a==o)return!1;var r=getRadioValues(),s=e(tr).closest("table").find("tbody"),l=i.clone(!0,!0);l.appendTo(s),a==o-1&&e(".add").removeClass("btn-success").addClass("disabled"),renameInputRow(l,a,!0),setRadioValues(r),resizeWin(),resetChosen(l)}return!1}.bind(this)),s.on("click","a.remove",function(n){if(tr=findTr(n)){tr.remove();{document.getElementById(t+"_table").getElementsByTagName("tbody")[0].getElementsByTagName("tr").length}e(".add").hasClass("disabled")&&e(".add").removeClass("disabled").addClass("btn-success")}return resizeWin(),!1}.bind(this))},resetChosen=function(t){t.find("select").removeClass("chzn-done").show(),e.each(t.find("select"),function(e,t){t.id=t.id+"_"+(1e7*Math.random()).toInt()}),t.find(".chzn-container").remove(),e("select").chosen({disable_search_threshold:10,allow_single_deselect:!0})},getTrs=function(){return s.find("tbody tr")},renameInputs=function(){var e,t=getTrs();for(e=0;e<t.length;e++)renameInputRow(t[e],e,!1)},renameInputRow=function(t,n,a){var o=/\[[0-9]\]/,i=/\[\]/;chx=e(t).find('input[type="radio"], input[type="checkbox"]'),e.each(chx,function(t,r){a?r.name=r.name.replace(o,"["+n+"]"):null===r.name.match(i)?(r.name+="["+n+"]",shortName=r.name.split("]["),shortName=shortName[shortName.length-2]):(r.name=r.name.replace(i,"["+n+"]"),r.name+="[]",shortName=r.name.split("]["),shortName=shortName[shortName.length-3]),id=r.id.split("_"),4===id.length&&a?(id[id.length-2]=shortName+t,id[id.length-1]=n):(id[id.length-1]=shortName+t,id.push(n)),r.id=id.join("_"),label=e(this).next("label"),label.attr("for",r.id)})},build=function(){var t,n,o,r,l,c,d,h,u;value=e(a).val(),value=value.replace(/\'/g,'"'),n=JSON.parse(value),"null"==typeof n&&(n={}),o=s.find("tbody tr"),r=Object.keys(n),l=0===r.length||0===n[r[0]].length?!0:!1,c=l?1:n[r[0]].length;for(var p=1;c>p;p++)t=o.clone(),t.insertAfter(o),resetChosen(t);for(renameInputs(),d=getTrs(),p=0;c>p;p++)e.each(r,function(t,a){e(d[p]).find('*[name*="'+this+'"]').each(function(t,o){h=e(o).attr("type"),"radio"===h||"checkbox"===h?(u="object"==typeof n[a][p]?n[a][p]:[],u.contains(o.value)&&e(o).attr("checked","checked")):(e(o).val(n[a][p]),"SELECT"===e(o).prop("tagName")&&e(o).trigger("liszt:updated"))})});i=o,l&&o.remove()},findTr=function(t){target=e(t.target);var n=target.parents().filter(function(){return"tr"===e(this).prop("tagName").toLowerCase()});return 0===n.length?!1:n[0]},store=function(){var t,o,i,r,s={},c=/\[[0-9]\]/;for(t=0;t<n.length;t++)o=n[t],i=l.find('*[name*="'+o+'"]'),s[o]=[],e.each(i,function(t,n){if(r=e(this).attr("type"),"radio"===r||"checkbox"===r){var a=parseInt(n.name.match(c)[0].replace("[","").replace("]",""));"undefined"==typeof s[o][a]&&(s[o][a]=[]),"checked"===e(this).attr("checked")&&s[o][a].push(e(this).val())}else s[o].push(e(this).val())});return a.val(JSON.stringify(s)),!0},e(document).on("click",'*[data-modal="'+t+'"]',function(){return a=e(this).next("input"),d=e(this).closest("div.control-group"),l||(l=d.find("table")),openWindow(),!1})}}(jQuery);